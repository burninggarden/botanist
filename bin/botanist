#! /usr/bin/env bash

display_usage() {
	echo ""
	echo "Usage: botanist <command>"
	echo ""
	echo "Where <command> is one of:"
	echo "    bump    - performs a patch-level version bump, pushes to Git, and publishes to NPM"
	echo "    help    - show this menu"
	echo "    init    - initialize a new Typescript project in the current directory"
	echo "    resync  - updates this project's scripts and config files to the latest versions in Botanist"
	echo "    upgrade - upgrades Botanist on your system to the latest version"
	echo "    version - show the currently installed version of Botanist"
	echo ""
}

raise_error() {
	local error_message="$@"
	echo "${error_message}" 1>&2;
}

init() {
	DIR="$(npm root -g)"
	cp -r "$DIR/@burninggarden/botanist/templates/project/." .
	mv .gitignore.disabled .gitignore
	echo "Initialized new Typescript project in current directory."
	git init
	npm install
}

resync() {
	DIR="$(npm root -g)"
	cp -r "$DIR/@burninggarden/botanist/templates/project/bin/." ./bin
	cp "$DIR/@burninggarden/botanist/templates/project/.eslintrc.json" .eslintrc.json
	cp "$DIR/@burninggarden/botanist/templates/project/tsconfig.json" tsconfig.json
	echo "Updated local bin scripts and config files."
}

upgrade() {
	npm update -g @burninggarden/botanist
}

print_version() {
	node -p "require('$(npm root -g)/@burninggarden/botanist/package.json').version"
}

bump() {
	npm version patch
}


argument="$1"

if [[ -z $argument ]] ; then
	display_usage
	exit
fi

case $argument in
	-b|--bump|bump)
		bump
		;;
	-h|--help|help)
		display_usage
		;;
	-i|--init|init)
		init
		;;
	-r|--resync|resync)
		resync
		;;
	-u|--upgrade|upgrade)
		upgrade
		;;
	-v|--version|version)
		print_version
		;;
	*)
		raise_error "Unknown argument: ${argument}"
		display_usage
		;;
esac
